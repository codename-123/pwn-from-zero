# 문제되는 문자 식별

## 개요

이와 유사하게, 특정 애플리케이션에서도 "예약 문자(bad characters)"가 존재합니다. 이러한 문자는 항상 존재하는 것은 아니며, 애플리케이션마다 다를 수 있습니다. 예를 들어 흔히 문제되는 문자는 다음과 같습니다:

- `\x00` - 널 바이트 (Null Byte)
- `\x0A` - 줄 바꿈 (Line Feed)
- `\x0D` - 캐리지 리턴 (Carriage Return)
- `\xFF` - 폼 피드 (Form Feed)

이런 문제 문자를 식별하려면, 가능한 모든 문자를 포함한 바이트 스트링을 프로그램에 입력한 뒤 메모리 상태를 관찰합니다.

---

## 모든 문자 리스트 (CHARS 변수)

```bash
CHARS="\x00\x01\x02...\xff"  # 0x00부터 0xFF까지 256개 문자
```

- 길이 확인:

```bash
echo $CHARS | sed 's/\\x/ /g' | wc -w
# 출력: 256
```

- 버퍼 재계산:

```bash
Buffer = "\x55" * (1040 - 256 - 4) = 780
CHARS = 전체 문자
EIP = "\x66" * 4
```

---

## GDB에서 브레이크포인트 설정

```gdb
(gdb) disas main
(gdb) break bowfunc
```

## 프로그램 실행 및 입력 전달

```bash
gdb) run $(python -c 'print "\x55" * 780 + CHARS + "\x66" * 4')
```

- payload.txt에 저장 후 gdb 실행:
```bash
python3 -c 'print("\x55" * (1040 - 256 - 4) + "".join(["\\x%02x" % i for i in range(256)]) + "\x66" * 4)' > payload.txt
```

```bash
print("\x55" * (1040 - 256 - 4) // padding 값
"".join(["\\x%02x" % i for i in range(256)]) // bad characters 설정                                        
"\x66" * 4 // rip 주소 바이트 값
```
* run < payload.txt → stdin (gets() 쓸 때만)
* run $(cat payload.txt) → argv (strcpy(argv[1])일 때)

- 실행 중 널 바이트 경고:

```
/bin/bash: warning: command substitution: ignored null byte in input
```

---

## 스택 메모리 확인

```gdb
(gdb) x/2000xb $esp+500
```

- `\x55` 시작 위치 찾기
- 이후 CHARS 변수의 시작 위치 찾기
- CHARS가 `\x00`이 아닌 `\x01`부터 시작함을 확인 (널 바이트 무시됨)

- 수정:

```bash
Buffer = "\x55" * (1040 - 255 - 4) = 781
CHARS = "\x01\x02...\xff"  # \x00 제거됨
```

---

## 반복적 제거 과정 예시

1. 실행 후 `\x09`가 사라지고 `\x00`이 다시 나타남 → `\x09` 제거

```bash
Buffer = "\x55" * (1040 - 254 - 4) = 782
CHARS = "\x01\x02...\x08\x0a...\xff"
```

2. 다시 실행 → `\x0a`도 사라짐 확인 → `\x0a` 제거 등

> 이런 방식으로 CHARS를 줄여가며 실제로 입력 시 문제를 발생시키는 문자를 찾아냅니다.

---

## 요약

- 입력한 CHARS에서 문제가 되는 문자(= bad chars)는 입력값이 중간에 잘리거나, 예상 순서에서 누락된 문자로 식별됨.
- 발견된 bad chars는 제거하고, 버퍼 크기를 그에 맞춰 재조정함.
- 이 과정을 반복하여 신뢰할 수 있는 쉘코드를 생성할 수 있다.

